#!/bin/bash

if [ -z "$AMIGRAVE" ]; then
    echo "start.sh has not been executed or sourced as .profile, .bashrc or .zshrc"
    echo "You can symlink start.sh to one of those files using 'start.sh -i'"
    return
fi

update=0
use_bash=0
delete_on_logout=0
dest=".agr"

function usage {
    if [[ $1 != '' ]]; then
        echo $1
        echo
    fi
    echo "Usage: `basename $0` [-b 'force bash'] [-u 'update config'] [-d 'delete config on logout']" 1>&2; exit 1;
    exit
}

while getopts "bud" o; do
    case "${o}" in
        b) use_bash=1; echo "TODO" ;;  # if switch forwarded to remote start.sh, maybe setup some kind of persistance
        u) update=1 ;;
        d) delete_on_logout=1; echo "TODO" ;;
        *) usage ;;
    esac
done
shift $((OPTIND-1))

sshargs="$@"

if [[ $sshargs == '' ]]; then
    usage "ERROR: Please specify a host"
fi

function upload_config() {
    cd $AMIGRAVE
    tmpfile=$(mktemp --suffix='-agr-config.tar')
    branch=master
    git diff --exit-code --quiet
    if [[ $1 = 'update' && $? != 0 ]]; then
        # make a stash in order to get unstaged changes
        # can be garbage collected with git gc --prune=now if needed
        branch=$(git stash create)
    fi
    git archive -o $tmpfile $branch

    # take vim config in my luggages
    tar -u --file=$tmpfile config/.xdg/vim \
        --exclude='config/.xdg/vim/bundle/syntastic/*' \
        --exclude='config/.xdg/vim/bundle/jedi-vim/*' \
        --exclude='config/.xdg/vim/bundle/*/doc/*' \
        --exclude='config/.xdg/vim/bundle/*/*.gif' \
        --exclude='.git'

    scp -C $tmpfile "$sshargs":/tmp/agr.tgz
    rm $tmpfile
    ssh "$sshargs" "mkdir -p ~/$dest; cd ~/$dest; mv /tmp/agr.tgz .; tar -xf agr.tgz; rm agr.tgz"
}

function connect() {
    ssh "$sshargs" -t "~/$dest/start.sh"
}

if [ $update = 1 ]; then
    upload_config update
fi

connect

if [ $? -eq  127 ]; then
    upload_config
    connect
fi
