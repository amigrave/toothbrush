#!/bin/bash

update=0
if [ $1 = '-u' ]; then
    update=1
    shift
fi

# TODO: afterall do not allow arbitrary switch forwarding to ssh
#       just do a getopt switch
# TODO: -d option to delete config on logout
# TODO: factorize excludes
sshargs="$@"

function upload_config() {
    rsync \
        --exclude='avatars/*' \
        --exclude='config/bazaar/plugins/*' \
        --exclude='config/vim/bundle/syntastic/*' \
        --exclude='config/vim/bundle/jedi-vim/*' \
        --exclude='config/vim/bundle/*/doc/*' \
        --exclude='config/vim/bundle/*/*.gif' \
        --exclude='*.pyc' \
        --exclude='.git' \
        -avz $AMIGRAVE/* "$sshargs":.agr/

    if [ $? -ne 0 ]; then
        # probably rsync not installed on the other end
        cd $AMIGRAVE
        tmpfile=/tmp/agr.tgz
        rm -f $tmpfile
        tar \
            --exclude='avatars/*' \
            --exclude='config/bazaar/plugins/*' \
            --exclude='config/vim/bundle/syntastic/*' \
            --exclude='config/vim/bundle/jedi-vim/*' \
            --exclude='config/vim/bundle/*/doc/*' \
            --exclude='config/vim/bundle/*/*.gif' \
            --exclude='*.pyc' \
            --exclude='.git' \
            -zcvf $tmpfile .
        scp $tmpfile "$sshargs":/tmp/
        ssh "$sshargs" "mkdir -p ~/.agr; cd ~/.agr; mv /tmp/agr.tgz .; tar -xf agr.tgz"
    fi
}

if [ $update = 1 ]; then
    upload_config
fi

ssh "$sshargs" -t "~/.agr/start.sh"

if [ $? -ne 0 ]; then
    upload_config
    ssh "$sshargs" -t "~/.agr/start.sh"
fi
