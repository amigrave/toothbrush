#!/bin/bash

if [ -z "$AMIGRAVE" ]; then
    echo "start.sh has not been executed or sourced as .profile, .bashrc or .zshrc"
    echo "You can symlink start.sh to one of those files using 'start.sh -i'"
    return
fi

update=0
use_bash=0
delete_on_logout=0
dest=".agr"

function usage {
    if [[ $1 != '' ]]; then
        echo $1
        echo
    fi
    echo "Usage: `basename $0` [-b 'force bash'] [-u 'update config'] [-d 'delete config on logout']" 1>&2; exit 1;
    exit
}

while getopts "bud" o; do
    case "${o}" in
        b) use_bash=1; echo "TODO" ;;  # if switch forwarded to remote start.sh, maybe setup some kind of persistance
        u) update=1 ;;
        d) delete_on_logout=1; echo "TODO" ;;
        *) usage ;;
    esac
done
shift $((OPTIND-1))

EXCLUDES="
    --exclude='avatars/*'
    --exclude='config/bazaar/plugins/*'
    --exclude='config/vim/bundle/syntastic/*'
    --exclude='config/vim/bundle/jedi-vim/*'
    --exclude='config/vim/bundle/*/doc/*'
    --exclude='config/vim/bundle/*/*.gif'
    --exclude='*.pyc'
    --exclude='.git'
"
sshargs="$@"

if [[ $sshargs == '' ]]; then
    usage "ERROR: Please specify a host"
fi

function upload_config() {
    cd $AMIGRAVE
    tmpfile=$(mktemp).tgz
    git archive -o $tmpfile master
    # tar $EXCLUDES -zcvf $tmpfile .
    scp $tmpfile "$sshargs":/tmp/agr.tgz
    rm $tmpfile
    ssh "$sshargs" "mkdir -p ~/$dest; cd ~/$dest; mv /tmp/agr.tgz .; tar -xf agr.tgz; rm agr.tgz"
}

function connect() {
    ssh "$sshargs" -t "~/$dest/start.sh"
}

if [ $update = 1 ]; then
    upload_config
fi

connect

if [ $? -eq  127 ]; then
    upload_config
    connect
fi
