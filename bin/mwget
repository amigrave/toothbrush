#!/usr/bin/ruby
require "rubygems"
require "open-uri"
require "nokogiri"
require "escape"
require "uri"

url = ARGV[0]
prefix = ARGV[1] || ""
doc = Nokogiri::HTML(open(url))
uri = URI.parse(url)
exclude_ext = "html,htm,php,jpg,jpeg".split(",")
already_downloaded = []
doc.css("a").each do |link|
	l = link["href"].strip
	if l =~ /\.[a-zA-Z0-9]+$/
		file = l.split("/").last
		ext = file.split(".").last.downcase
		if already_downloaded.count(l).zero? and exclude_ext.count(ext).zero?
			if l.downcase !=~ /^[a-z]+:\/\//
				l = uri.merge(l).to_s
			end
			#w = `#{Escape.shell_command(["wget", "-q", l])}`
			dest = prefix + file
			puts "Downloading #{l} -> #{dest}"
			w = `#{Escape.shell_command(["curl", "-o", dest, l])}`
			already_downloaded << l
		else
			puts "Not downloading #{l}"
		end
	end
end

