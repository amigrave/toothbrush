# vim: ft=sh:fdm=marker:

# Global environment {{{
if [ -z "$AMIGRAVE" ]; then
    echo "start.sh has not been executed or sourced as .profile, .bashrc or .zshrc"
    echo "You can symlink start.sh to one of those files using 'start.sh -i'"
    return
fi
export LANG=en_US.UTF-8
export LC_ALL=$LANG
export LC_CTYPE=$LANG
export LC_COLLATE=C

# Applicatons
export EDITOR=vim
export VISUAL=vim
export TERMINAL=terminator
export BROWSER=google-chrome

export VIMINIT='let $MYVIMRC="$DOTFILES/vim/vimrc" | source $MYVIMRC'
export LESS="--no-init --ignore-case --LONG-PROMPT --silent --tabs=4 -R -F"
export LS_OPTIONS='--color=auto'
export GREP_OPTIONS='--color=auto'

# https://gist.github.com/cjbarnes18/4078704
# enable this for non-reparenting window managers
export _JAVA_AWT_WM_NONREPARENTING=1

# Set up paths
PATH=$AMIGRAVE/bin:$PATH
if [ -d "$HOME/bin" ]; then
    PATH=$HOME/bin:$PATH
fi
if [ -d "$HOME/.local/bin" ]; then
    PATH=$HOME/.local/bin:$PATH
fi
python_site_package=$HOME/.local/lib/python2.7/site-packages/
if [ -f "$python_site_package" ]; then
    # TODO: python version !!!
    export PYTHONPATH=$python_site_package:$PYTHONPATH
fi

export XDG_CONFIG_HOME=$DOTFILES
export XDG_CACHE_HOME=$HOME/.cache

export MC_SKIN=$DOTFILES/mc/skins/agr.ini
# TODO: check if all of them are still mandatory now that XDG_CONFIG_DIR == DOTFILES
export PYTHONSTARTUP=$DOTFILES/python/shell_startup.py
export ZDOTDIR=$DOTFILES/zsh
export MPLAYER_HOME=$DOTFILES/mplayer
export MPV_HOME=$DOTFILES/mpv
export IPYTHONDIR=$DOTFILES/ipython
export INPUTRC=$DOTFILES/inputrc
export SCREENRC=$DOTFILES/screenrc
export IRBRC=$DOTFILES/irbrc
export LFTP_HOME=$DOTFILES/lftp
export MPV_HOME=$DOTFILES/mpv
export HTTPIE_CONFIG_DIR=$DOTFILES/httpie
export PSQLRC=$DOTFILES/psqlrc
export WGETRC=$DOTFILES/wgetrc
export GIMP2_DIRECTORY="$DOTFILES/gimp"

export DVDCSS_CACHE=$XDG_CACHE_HOME/dvdcss/
export LESSHISTFILE=$XDG_CACHE_HOME/less_history
export ERRFILE=$XDG_CACHE_HOME/xsession-errors.log
export BZR_LOG=/dev/null
# }}}

# Node {{{
if [ -d "/usr/local/lib/node_modules" ]; then
    NODE_PATH="/usr/local/lib/node_modules"
fi
# }}}

# Homebrew {{{
if [ -d "/usr/local/Cellar/coreutils" ]; then
    MANPATH="/usr/local/opt/coreutils/libexec/gnuman:$MANPATH"
    PATH="/usr/local/sbin:/usr/local/opt/coreutils/libexec/gnubin:$PATH"
fi
# }}}

# Load local profile {{{
if [ -f "$XDG_CONFIG_HOME/profile_local" ]; then
    # should point to ~/.agr/config/.xdg/profile_local
    . $XDG_CONFIG_HOME/profile_local
elif [ -f "~/.config/profile_local" ]; then
    . ~/.config/profile_local
fi
# }}}

# If not running interactively, don't do anything further
[ -z "$PS1" ] && return

# Misc Interactive mode stuff {{{
source $DOTFILES/aliases
eval `dircolors -b $DOTFILES/dir_colors `
# }}}

# Set up terminal emulation {{{
export TERMINFO=$XDG_CONFIG_HOME/terminfo
if [[ "$COLORTERM" == "rxvt-xpm" ]]; then
    export TERM="rxvt-256color"
elif [[ "$COLORTERM" == "gnome-terminal" ]]; then
    # TODO: check issues with S-F* keys
    # export TERM="gnome-256color"
    export TERM="xterm-256color"
elif [[ "$TERM" == "screen" ]]; then
    export TERM="screen-256color"
elif [[ "$TERM" == "screen-bce" ]]; then
    export TERM="screen-256color-bce-s"
elif [[ "$KONSOLE_DBUS_SESSION" != "" ]]; then
    export TERM="konsole-256color"
fi
# }}}

# TODO: src-highlight {{{
# LESSPIPE=`which src-hilite-lesspipe.sh`
# alias src='LESSOPEN="| ${LESSPIPE} %s" less'
# }}}

# OS dependencies {{{
if [[ "$OSTYPE" == "linux" || "$OSTYPE" == "linux-gnu" ]]; then

    # TODO: do it only once under X session and not in remote session
    # Use xbindkeys if installed
    # if [ -x "$(command -v xbindkeys)" ]; then
    #     xbindkeys -f $DOTFILES/xbindkeysrc
    # fi

    # make less more friendly for non-text input files, see lesspipe(1)
    [ -x /usr/bin/lesspipe ] && eval "$(SHELL=/bin/sh lesspipe)"

    # SDL Fullscreen second monitor
    # export SDL_VIDEO_FULLSCREEN_HEAD=1
    # export SDL_AUDIODRIVER=alsa
elif [[ "$OSTYPE" == "cygwin" ]]; then

    termsetcolors

elif [[ "$OSTYPE" =~ darwin* ]]; then

    export BROWSER=safari

fi
# }}}
